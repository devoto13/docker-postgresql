#!/bin/bash -e

chown -R postgres:postgres /var/lib/postgresql/9.3/main
chown -R postgres:postgres /var/log/postgresql
chown -R postgres:postgres /etc/postgresql/9.3/main/conf.d

PATH=/usr/lib/postgresql/9.3/bin
CONFIG=/etc/postgresql/9.3/main/postgresql.conf

mydb=${POSTGRESQL_DATABASE:-""}
myuser=${POSTGRESQL_USER:-""}
mypass=${POSTGRESQL_PASSWORD:-""}
mychset=${POSTGRESQL_CHARACTER_SET:-"utf8"}
myhost=${GRANT_HOSTNAME:-"%"}

if [[ $mydb != "" ]]; then
   sudo -u postgres $PATH/postgres --single --config-file=$CONFIG <<< "CREATE DATABASE IF NOT EXISTS \`$mydb\` CHARACTER SET \`$mychset\` COLLATE \`$mycollate\`;"

   if [[ $myuser != "" ]]; then
       sudo -u postgres $PATH/postgres --single --config-file=$CONFIG <<< "GRANT ALL ON \`$mydb\`.* TO '$myuser'@'$myhost' IDENTIFIED BY '$mypass';"
   fi
fi

exec supervisord
